---
title: 'Chrome'
date: '2023-12-10'
lastmod: '2023-12-10'
tags: ['nestjs', 'typescript', 'javascript', 'design-patterns']
summary: 'Modules are crucial components at the center of NestJS. In this post, we will take a closer look at what modules are in NestJS.'
---

import Twemoji from './components/ui/Twemoji';

## 浏览器渲染流程全解：从 HTML 到屏幕的奇妙旅程

我们平时写下的 HTML、CSS、JavaScript, 最终是怎么变成屏幕上的页面的呢？这背后有一条复杂而高效的流水线。可以大体分为 **解析** 和 **渲染** 两个阶段。

---

## 解析：搭建 DOM 世界

第一步, 浏览器需要把 HTML 代码“翻译”成它能理解的结构, 这个过程叫 **解析**。

### 构建 DOM 树

- **HTML 解析器** 会把 HTML 一行行读进去, 交给 **分词器** 切分成 **token** (类似词法分析) 。
- 然后这些 token 会被转化为 **DOM 节点**, 逐步拼装成一棵 **DOM 树**。
- 在构建过程中, 会维护一个 **token 栈**, 来保证嵌套关系正确。

📌 重点：

- 如果遇到 `<script>` 标签, 解析会被“打断”。
  - 内联脚本：暂停解析 → 执行脚本 → 再继续解析。
  - 外链脚本：需要先下载资源, 下载完成后再执行。
- 为了减少等待, **Chrome 渲染进程里会有一个“预解析线程”**, 在后台悄悄帮你提前加载 script、link 等外部资源。

### 实时解析

解析不是一口气全做完的, 而是随着 HTML 流式下载 **边下载边解析**。这就是为什么页面能一点点出现, 而不是等所有内容都下完再显示。

---

## 渲染：让页面“活”起来

有了 DOM 树只是第一步, 接下来要经历一系列步骤, 才能真正画到屏幕上。

### 计算样式 (Style)

- 浏览器会收集所有 CSS：包括 link 引入、style 标签、元素内嵌样式。
- 它们会被转化为 **StyleSheet** 对象。
- 接着为 DOM 树上的每个节点计算出最终的样式。
- 样式有继承性, 子节点会自动继承父节点的属性。

### 布局 (Layout)

- 将 DOM 树和 StyleSheet 结合, 生成一棵 **布局树 (Layout Tree) **。
- 遍历 DOM, 把所有可见节点都放进去。
- 然后根据 CSS 规则, 计算出每个节点的具体 **位置和大小**。

### 分层 (Layering)

- 页面上的元素不是一股脑画在一起, 而是会被划分成不同的“层”。
- 比如有些复杂的元素 (position、z-index、动画等) 会单独成层。
- 在 Chrome DevTools 的 **Layers 面板**里就能看到这些层。

### 绘制 (Paint)

- 每一层内部, 再拆分成具体的绘制步骤。
- 比如先画背景, 再画边框, 最后画文字。
- 这些信息被记录下来, 形成绘制列表。

### 分块 (Tiling)

- 绘制列表不会一次性渲染整个页面, 而是被切分成一个个小块 (tile) 。
- 这样做的好处是：只需要渲染用户视口内的部分, 提高性能。

### 光栅化 (Rasterization)

- 每个 tile 会交给 **栅格化线程池**, 在后台把绘制指令转化为位图。
- 这一步通常会借助 GPU 加速完成。

### 合成 (Compositing)

- 最后, 合成线程把各个图层、图块“拼接”在一起, 交给 GPU, 绘制到屏幕上。
- 至此, 一个页面的完整画面就呈现出来啦！

---

## 重排、重绘、合成：性能杀手

在开发中, 我们经常会听到 **重排 (Reflow) **、**重绘 (Repaint) ** 和 **合成 (Composite) **, 它们其实就是渲染流水线的不同阶段被重新触发。

- **重排**：当修改了元素的几何属性 (宽高、位置、结构等) , 需要重新布局。代价最高。
- **重绘**：仅仅是样式改变 (颜色、背景) , 跳过布局, 但仍需重新绘制。
- **合成**：只改变 transform、opacity 这类属性, 可以直接在合成阶段搞定, 性能最好。

开发时尽量优化, 避免频繁触发重排和重绘。

---

## 总结

浏览器的渲染过程就像一条精密的装配线：

1. **解析**：从 HTML 出发, 搭建 DOM 世界。
2. **渲染**：计算样式 → 布局 → 分层 → 绘制 → 分块 → 光栅化 → 合成 → 屏幕显示。

理解这套机制, 可以帮助我们写出性能更好的前端代码, 也能在排查页面卡顿时更有思路。

Happy reading! <Twemoji emoji="clinking-beer-mugs" />
