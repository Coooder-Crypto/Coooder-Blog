---
title: 'Next.js + tRPCï¼šç‹¬ç«‹å¼€å‘è€…çš„æœ€ä½³å®è·µæŠ€æœ¯æ ˆ'
date: '2025-01-19'
tags: ['nextjs', 'trpc', 'typescript', 'fullstack', 'solo-development']
summary: 'æ·±å…¥æ¢ç´¢ Next.js + tRPC æŠ€æœ¯æ ˆå¦‚ä½•æˆä¸ºç‹¬ç«‹å¼€å‘è€…æ„å»ºå…¨æ ˆåº”ç”¨çš„æœ€ä¼˜é€‰æ‹©ï¼ŒåŒ…å«å®Œæ•´çš„æŠ€æœ¯æ ˆä»‹ç»ã€æœ€ä½³å®è·µå’Œå®æˆ˜æ¡ˆä¾‹ã€‚'
draft: false
---

ä½œä¸ºç‹¬ç«‹å¼€å‘è€…ï¼Œé€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ ˆæ˜¯é¡¹ç›®æˆåŠŸçš„å…³é”®ã€‚åœ¨ç»å†äº†æ— æ•°æ¬¡æŠ€æœ¯é€‰å‹çš„çº ç»“åï¼Œæˆ‘å‘ç° **Next.js + tRPC** è¿™ä¸ªç»„åˆå ªç§°ç‹¬ç«‹å¼€å‘çš„é»„é‡‘æ­æ¡£ã€‚ä»Šå¤©å°±æ¥è¯¦ç»†èŠèŠä¸ºä»€ä¹ˆè¿™ä¸ªæŠ€æœ¯æ ˆå¦‚æ­¤é€‚åˆç‹¬ç«‹å¼€å‘è€…ï¼Œä»¥åŠå¦‚ä½•åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨ã€‚

## ä¸ºä»€ä¹ˆ Next.js + tRPC æ˜¯ç‹¬ç«‹å¼€å‘çš„ç†æƒ³é€‰æ‹©ï¼Ÿ

### 1. ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨

ä¼ ç»Ÿçš„å‰åç«¯åˆ†ç¦»å¼€å‘ä¸­ï¼ŒAPI æ¥å£çš„ç±»å‹å®šä¹‰å¾€å¾€æ˜¯æœ€å¤§çš„ç—›ç‚¹ã€‚è€Œ tRPC å®Œç¾è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼š

```typescript
// åç«¯ API å®šä¹‰
export const userRouter = router({
  getById: publicProcedure
    .input(z.object({ id: z.string() }))
    .query(async ({ input }) => {
      return await db.user.findUnique({
        where: { id: input.id }
      })
    }),

  create: publicProcedure
    .input(z.object({
      name: z.string().min(2),
      email: z.string().email()
    }))
    .mutation(async ({ input }) => {
      return await db.user.create({
        data: input
      })
    })
})

// å‰ç«¯è°ƒç”¨ï¼Œå®Œå…¨ç±»å‹å®‰å…¨
const CreateUser = () => {
  const createUser = trpc.user.create.useMutation()

  const handleSubmit = (data: { name: string; email: string }) => {
    // TypeScript ä¼šæ£€æŸ¥ç±»å‹ï¼ŒIDE æœ‰å®Œæ•´æç¤º
    createUser.mutate(data)
  }
}
```

### 2. å¼€å‘æ•ˆç‡æé«˜

- **æ— éœ€å†™ API æ–‡æ¡£**ï¼štRPC è‡ªåŠ¨ç”Ÿæˆç±»å‹å®šä¹‰
- **å®æ—¶ç±»å‹æ£€æŸ¥**ï¼šåç«¯ä¿®æ”¹ç«‹å³åé¦ˆåˆ°å‰ç«¯
- **é›¶æ ·æ¿ä»£ç **ï¼šå‘Šåˆ«ç¹ççš„ API å±‚å°è£…

### 3. å®Œç¾çš„ DXï¼ˆå¼€å‘è€…ä½“éªŒï¼‰

```typescript
// ä¸€ä¸ªå®Œæ•´çš„ tRPC æŸ¥è¯¢ï¼ŒåŒ…å«åŠ è½½çŠ¶æ€ã€é”™è¯¯å¤„ç†
const ProfilePage = () => {
  const { data: user, isLoading, error } = trpc.user.getProfile.useQuery()

  if (isLoading) return <Spinner />
  if (error) return <ErrorMessage error={error.message} />

  return <UserProfile user={user} />
}
```

## å®Œæ•´æŠ€æœ¯æ ˆæ¶æ„

è®©æˆ‘ä»¬æ„å»ºä¸€ä¸ªç°ä»£åŒ–çš„å…¨æ ˆåº”ç”¨æŠ€æœ¯æ ˆï¼š

### æ ¸å¿ƒæ¡†æ¶å±‚

```json
{
  "dependencies": {
    "next": "^14.0.0",
    "@trpc/server": "^10.45.0",
    "@trpc/client": "^10.45.0",
    "@trpc/react-query": "^10.45.0",
    "@trpc/next": "^10.45.0"
  }
}
```

### æ•°æ®åº“ & ORM

**æ¨èï¼šPrisma + PostgreSQL**

```prisma
// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  posts     Post[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String?
  published Boolean  @default(false)
  author    User     @relation(fields: [authorId], references: [id])
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

### éªŒè¯å±‚

**Zod** æä¾›è¿è¡Œæ—¶ç±»å‹éªŒè¯ï¼š

```typescript
import { z } from 'zod'

export const createPostSchema = z.object({
  title: z.string().min(1, 'æ ‡é¢˜ä¸èƒ½ä¸ºç©º').max(100, 'æ ‡é¢˜è¿‡é•¿'),
  content: z.string().min(10, 'å†…å®¹è‡³å°‘10ä¸ªå­—ç¬¦'),
  published: z.boolean().default(false)
})

export type CreatePostInput = z.infer<typeof createPostSchema>
```

### èº«ä»½éªŒè¯

**NextAuth.js** é›†æˆï¼š

```typescript
// lib/auth.ts
import NextAuth from 'next-auth'
import GoogleProvider from 'next-auth/providers/google'
import { PrismaAdapter } from "@next-auth/prisma-adapter"
import { prisma } from './prisma'

export const authOptions = {
  adapter: PrismaAdapter(prisma),
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
  ],
  callbacks: {
    session: ({ session, user }) => ({
      ...session,
      user: {
        ...session.user,
        id: user.id,
      },
    }),
  },
}

export default NextAuth(authOptions)
```

## é¡¹ç›®ç»“æ„æœ€ä½³å®è·µ

```
my-app/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                 # Next.js 13+ App Router
â”‚   â”‚   â”œâ”€â”€ api/trpc/[trpc]/ # tRPC API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ (auth)/          # è®¤è¯ç›¸å…³é¡µé¢
â”‚   â”‚   â””â”€â”€ dashboard/       # å—ä¿æŠ¤çš„é¡µé¢
â”‚   â”œâ”€â”€ server/              # åç«¯é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ api/             # tRPC è·¯ç”±å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ post.ts
â”‚   â”‚   â”‚   â””â”€â”€ root.ts
â”‚   â”‚   â”œâ”€â”€ auth.ts          # è®¤è¯é…ç½®
â”‚   â”‚   â””â”€â”€ db.ts            # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ lib/                 # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ utils.ts
â”‚   â”‚   â””â”€â”€ trpc.ts          # tRPC å®¢æˆ·ç«¯é…ç½®
â”‚   â””â”€â”€ components/          # React ç»„ä»¶
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma
â”‚   â””â”€â”€ migrations/
â””â”€â”€ public/
```

## å®æˆ˜æ¡ˆä¾‹ï¼šæ„å»ºåšå®¢ç³»ç»Ÿ

### 1. tRPC è·¯ç”±å®šä¹‰

```typescript
// src/server/api/routers/post.ts
import { z } from 'zod'
import { createTRPCRouter, publicProcedure, protectedProcedure } from '../trpc'

export const postRouter = createTRPCRouter({
  // è·å–æ–‡ç« åˆ—è¡¨ï¼ˆå…¬å¼€ï¼‰
  getAll: publicProcedure
    .input(z.object({
      limit: z.number().min(1).max(100).default(10),
      cursor: z.string().optional(),
      published: z.boolean().default(true)
    }))
    .query(async ({ ctx, input }) => {
      const posts = await ctx.prisma.post.findMany({
        take: input.limit + 1,
        cursor: input.cursor ? { id: input.cursor } : undefined,
        where: { published: input.published },
        include: { author: { select: { name: true, email: true } } },
        orderBy: { createdAt: 'desc' }
      })

      let nextCursor: string | undefined = undefined
      if (posts.length > input.limit) {
        const nextItem = posts.pop()
        nextCursor = nextItem!.id
      }

      return { posts, nextCursor }
    }),

  // è·å–å•ç¯‡æ–‡ç« 
  getById: publicProcedure
    .input(z.object({ id: z.string() }))
    .query(async ({ ctx, input }) => {
      const post = await ctx.prisma.post.findUnique({
        where: { id: input.id },
        include: { author: { select: { name: true, email: true } } }
      })

      if (!post) {
        throw new TRPCError({
          code: 'NOT_FOUND',
          message: 'æ–‡ç« ä¸å­˜åœ¨'
        })
      }

      return post
    }),

  // åˆ›å»ºæ–‡ç« ï¼ˆéœ€è¦è®¤è¯ï¼‰
  create: protectedProcedure
    .input(createPostSchema)
    .mutation(async ({ ctx, input }) => {
      return await ctx.prisma.post.create({
        data: {
          ...input,
          authorId: ctx.session.user.id
        }
      })
    }),

  // æ›´æ–°æ–‡ç« 
  update: protectedProcedure
    .input(z.object({
      id: z.string(),
      data: createPostSchema.partial()
    }))
    .mutation(async ({ ctx, input }) => {
      const post = await ctx.prisma.post.findUnique({
        where: { id: input.id }
      })

      if (!post || post.authorId !== ctx.session.user.id) {
        throw new TRPCError({
          code: 'FORBIDDEN',
          message: 'æ— æƒé™æ“ä½œ'
        })
      }

      return await ctx.prisma.post.update({
        where: { id: input.id },
        data: input.data
      })
    })
})
```

### 2. å‰ç«¯ç»„ä»¶å®ç°

```typescript
// components/PostList.tsx
import { trpc } from '@/lib/trpc'
import { useState } from 'react'

export const PostList = () => {
  const [cursor, setCursor] = useState<string>()

  const {
    data,
    isLoading,
    error,
    fetchNextPage,
    hasNextPage,
    isFetchingNextPage
  } = trpc.post.getAll.useInfiniteQuery(
    { limit: 10 },
    {
      getNextPageParam: (lastPage) => lastPage.nextCursor,
    }
  )

  if (isLoading) return <div>åŠ è½½ä¸­...</div>
  if (error) return <div>é”™è¯¯: {error.message}</div>

  return (
    <div className="space-y-6">
      {data?.pages.map((page, i) => (
        <div key={i} className="space-y-4">
          {page.posts.map((post) => (
            <article key={post.id} className="border rounded-lg p-6">
              <h2 className="text-xl font-bold">{post.title}</h2>
              <p className="text-gray-600 mt-2">{post.content}</p>
              <div className="text-sm text-gray-500 mt-4">
                ä½œè€…: {post.author.name} |
                å‘å¸ƒæ—¶é—´: {new Date(post.createdAt).toLocaleDateString()}
              </div>
            </article>
          ))}
        </div>
      ))}

      {hasNextPage && (
        <button
          onClick={() => fetchNextPage()}
          disabled={isFetchingNextPage}
          className="w-full py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
        >
          {isFetchingNextPage ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}
        </button>
      )}
    </div>
  )
}
```

### 3. è¡¨å•å¤„ç†ä¸ä¹è§‚æ›´æ–°

```typescript
// components/CreatePostForm.tsx
import { trpc } from '@/lib/trpc'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { createPostSchema, type CreatePostInput } from '@/lib/schemas'

export const CreatePostForm = () => {
  const utils = trpc.useContext()

  const createPost = trpc.post.create.useMutation({
    onSuccess: () => {
      // é‡æ–°è·å–æ–‡ç« åˆ—è¡¨
      utils.post.getAll.invalidate()
      reset()
    },
    onError: (error) => {
      console.error('åˆ›å»ºå¤±è´¥:', error.message)
    }
  })

  const {
    register,
    handleSubmit,
    reset,
    formState: { errors, isSubmitting }
  } = useForm<CreatePostInput>({
    resolver: zodResolver(createPostSchema)
  })

  const onSubmit = (data: CreatePostInput) => {
    createPost.mutate(data)
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
      <div>
        <label className="block text-sm font-medium">æ ‡é¢˜</label>
        <input
          {...register('title')}
          className="mt-1 block w-full border rounded-md px-3 py-2"
          placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜"
        />
        {errors.title && (
          <p className="text-red-500 text-sm mt-1">{errors.title.message}</p>
        )}
      </div>

      <div>
        <label className="block text-sm font-medium">å†…å®¹</label>
        <textarea
          {...register('content')}
          rows={10}
          className="mt-1 block w-full border rounded-md px-3 py-2"
          placeholder="è¯·è¾“å…¥æ–‡ç« å†…å®¹"
        />
        {errors.content && (
          <p className="text-red-500 text-sm mt-1">{errors.content.message}</p>
        )}
      </div>

      <div className="flex items-center">
        <input
          {...register('published')}
          type="checkbox"
          className="mr-2"
        />
        <label className="text-sm">ç«‹å³å‘å¸ƒ</label>
      </div>

      <button
        type="submit"
        disabled={isSubmitting || createPost.isLoading}
        className="w-full py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
      >
        {isSubmitting || createPost.isLoading ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒæ–‡ç« '}
      </button>
    </form>
  )
}
```

## æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

### 1. æ™ºèƒ½ç¼“å­˜ç­–ç•¥

```typescript
// lib/trpc.ts
import { httpBatchLink } from '@trpc/client'
import { createTRPCNext } from '@trpc/next'
import type { AppRouter } from '@/server/api/root'

export const trpc = createTRPCNext<AppRouter>({
  config() {
    return {
      links: [
        httpBatchLink({
          url: '/api/trpc',
          // æ‰¹é‡è¯·æ±‚ä¼˜åŒ–
          maxBatchSize: 10,
        }),
      ],
      // React Query é…ç½®
      queryClientConfig: {
        defaultOptions: {
          queries: {
            staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿ
            cacheTime: 10 * 60 * 1000, // 10åˆ†é’Ÿ
          },
        },
      },
    }
  },
  ssr: false, // æ ¹æ®éœ€è¦å¯ç”¨ SSR
})
```

### 2. æ•°æ®é¢„å–

```typescript
// pages/posts/index.tsx
import { createServerSideHelpers } from '@trpc/react-query/server'
import { appRouter } from '@/server/api/root'
import { createTRPCContext } from '@/server/api/trpc'

export async function getStaticProps() {
  const helpers = createServerSideHelpers({
    router: appRouter,
    ctx: await createTRPCContext({ req: null, res: null }),
  })

  // é¢„å–æ•°æ®
  await helpers.post.getAll.prefetch({ limit: 10 })

  return {
    props: {
      trpcState: helpers.dehydrate(),
    },
    revalidate: 60, // ISR
  }
}
```

## éƒ¨ç½²ä¸è¿ç»´

### 1. Docker é…ç½®

```dockerfile
# Dockerfile
FROM node:18-alpine AS deps
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci --only=production

FROM node:18-alpine AS builder
WORKDIR /app
COPY . .
COPY --from=deps /app/node_modules ./node_modules
RUN npm run build

FROM node:18-alpine AS runner
WORKDIR /app
ENV NODE_ENV production
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
EXPOSE 3000
CMD ["node", "server.js"]
```

### 2. ç¯å¢ƒå˜é‡ç®¡ç†

```bash
# .env.local
DATABASE_URL="postgresql://user:password@localhost:5432/myapp"
NEXTAUTH_SECRET="your-secret-key"
NEXTAUTH_URL="http://localhost:3000"
GOOGLE_CLIENT_ID="your-google-client-id"
GOOGLE_CLIENT_SECRET="your-google-client-secret"
```

## ç›‘æ§ä¸é”™è¯¯å¤„ç†

### 1. é”™è¯¯è¾¹ç•Œ

```typescript
// components/ErrorBoundary.tsx
import { TRPCClientError } from '@trpc/client'

export const TRPCErrorBoundary = ({ children }: { children: React.ReactNode }) => {
  return (
    <ErrorBoundary
      fallback={({ error }) => {
        if (error instanceof TRPCClientError) {
          return <div>API é”™è¯¯: {error.message}</div>
        }
        return <div>æœªçŸ¥é”™è¯¯</div>
      }}
    >
      {children}
    </ErrorBoundary>
  )
}
```

### 2. æ—¥å¿—è®°å½•

```typescript
// server/api/trpc.ts
import { TRPCError } from '@trpc/server'

export const createTRPCContext = async ({ req, res }: CreateContextOptions) => {
  // æ·»åŠ è¯·æ±‚æ—¥å¿—
  console.log(`ğŸ“¡ tRPC Request: ${req?.method} ${req?.url}`)

  return {
    req,
    res,
    prisma,
    session: await getServerAuthSession({ req, res })
  }
}

const loggerMiddleware = t.middleware(async ({ path, type, next }) => {
  const start = Date.now()
  const result = await next()
  const durationMs = Date.now() - start

  const meta = { path, type, durationMs }

  if (result.ok) {
    console.log('âœ… OK request timing:', meta)
  } else {
    console.error('âŒ Non-OK request timing', meta)
  }

  return result
})
```

## æ€»ç»“

Next.js + tRPC è¿™ä¸ªæŠ€æœ¯æ ˆä¸ºç‹¬ç«‹å¼€å‘è€…æä¾›äº†ï¼š

### æ ¸å¿ƒä¼˜åŠ¿
- **ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨**ï¼šä»æ•°æ®åº“åˆ° UI çš„å®Œæ•´ç±»å‹ä¿æŠ¤
- **å¼€å‘æ•ˆç‡æé«˜**ï¼šå‡å°‘é‡å¤ä»£ç ï¼Œä¸“æ³¨ä¸šåŠ¡é€»è¾‘
- **ç°ä»£åŒ– DX**ï¼šä¼˜ç§€çš„å¼€å‘è€…ä½“éªŒå’Œå·¥å…·æ”¯æŒ
- **æ¸è¿›å¼é‡‡ç”¨**ï¼šå¯ä»¥ä»å°é¡¹ç›®å¼€å§‹ï¼Œé€æ­¥æ‰©å±•

### é€‚ç”¨åœºæ™¯
- âœ… ä¸ªäººé¡¹ç›®å’Œ MVP å¼€å‘
- âœ… å°åˆ°ä¸­å‹å›¢é˜Ÿçš„äº§å“å¼€å‘
- âœ… éœ€è¦å¿«é€Ÿè¿­ä»£çš„åˆ›ä¸šé¡¹ç›®
- âœ… å¯¹ç±»å‹å®‰å…¨æœ‰è¾ƒé«˜è¦æ±‚çš„é¡¹ç›®

### æ³¨æ„äº‹é¡¹
- å­¦ä¹ æ›²çº¿ï¼šéœ€è¦ç†Ÿæ‚‰ TypeScript å’Œ React Query
- å›¢é˜Ÿåä½œï¼šéœ€è¦å‰åç«¯éƒ½ä½¿ç”¨ TypeScript
- é¡¹ç›®è§„æ¨¡ï¼šè¶…å¤§å‹é¡¹ç›®å¯èƒ½éœ€è¦è€ƒè™‘å¾®æœåŠ¡æ¶æ„

ä½œä¸ºç‹¬ç«‹å¼€å‘è€…ï¼Œé€‰æ‹© Next.js + tRPC æ„å‘³ç€ä½ å¯ä»¥ç”¨æ›´å°‘çš„æ—¶é—´æ„å»ºæ›´ç¨³å®šçš„å…¨æ ˆåº”ç”¨ã€‚è¿™ä¸ªæŠ€æœ¯æ ˆä¸ä»…æä¾›äº†ä¼˜ç§€çš„å¼€å‘ä½“éªŒï¼Œè¿˜ä¸ºé¡¹ç›®çš„é•¿æœŸç»´æŠ¤å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚

å¦‚æœä½ æ­£åœ¨å¯»æ‰¾ä¸€ä¸ªæ—¢ç°ä»£åˆå®ç”¨çš„å…¨æ ˆå¼€å‘æ–¹æ¡ˆï¼Œä¸å¦¨è¯•è¯•è¿™ä¸ªç»„åˆâ€”â€”ç›¸ä¿¡ä½ ä¼šçˆ±ä¸Šè¿™ç§"ä¸€æ¬¡ç¼–å†™ï¼Œå¤„å¤„ç±»å‹å®‰å…¨"çš„å¼€å‘ä½“éªŒã€‚